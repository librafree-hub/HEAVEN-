<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HEAVEN - 写メ日記</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="app">
    <!-- サイドバー -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h1>HEAVEN</h1>
        <p>自動化システム</p>
      </div>
      <ul class="nav-menu">
        <li class="nav-section">メイン</li>
        <li><a href="/" class="active">写メ日記</a></li>
        <li><a href="/mitene">ミテネ</a></li>
        <li class="nav-section">管理</li>
        <li><a href="#" data-page="settings">設定</a></li>
      </ul>
    </nav>

    <!-- メインコンテンツ -->
    <main class="content">

      <!-- ===== 写メ日記ページ ===== -->
      <div id="page-diary" class="page active">
        <h2>写メ日記 自動投稿</h2>

        <!-- ステータスパネル -->
        <div class="status-panel">
          <div class="status-panel-item">
            <div class="status-panel-icon" id="diary-live-icon">&#9679;</div>
            <div>
              <div class="status-panel-label">スケジューラー</div>
              <div class="status-panel-value" id="diary-live-status">停止中</div>
            </div>
          </div>
          <div class="status-panel-item">
            <div>
              <div class="status-panel-label">最終投稿</div>
              <div class="status-panel-value" id="diary-last-run">-</div>
            </div>
          </div>
          <div class="status-panel-item">
            <div>
              <div class="status-panel-label">今日の投稿</div>
              <div class="status-panel-value" id="diary-today-count">0 件</div>
            </div>
          </div>
          <div class="status-panel-item">
            <div>
              <div class="status-panel-label">成功 / 失敗</div>
              <div class="status-panel-value" id="diary-today-result">0 / 0</div>
            </div>
          </div>
        </div>

        <!-- 操作ボタン -->
        <div class="action-bar">
          <button class="btn btn-primary btn-lg" onclick="App.postAll()">全アカウント投稿</button>
          <button class="btn btn-secondary" id="btn-diary-scheduler" onclick="App.toggleScheduler()">スケジューラー開始</button>
          <span id="diary-scheduler-status" class="status-badge">停止中</span>
        </div>

        <!-- スケジュール予定 -->
        <div class="card" id="schedule-panel" style="display:none;">
          <h3>投稿スケジュール</h3>
          <div style="display:flex; gap:16px; align-items:center; margin-bottom:12px;">
            <span style="font-size:14px; color:#888;">Cron式:</span>
            <code id="schedule-cron" style="background:#2a2a2a; padding:4px 8px; border-radius:4px;">-</code>
            <span id="schedule-description" style="font-size:13px; color:#aaa;"></span>
          </div>
          <div id="schedule-next-runs">
            <div class="loading">読み込み中...</div>
          </div>
        </div>

        <!-- アカウント管理（写メ日記専用） -->
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3 style="margin-bottom:0;">写メ日記 アカウント</h3>
            <button class="btn btn-sm btn-primary" onclick="App.showAddAccount()">+ 追加</button>
          </div>
          <div id="diary-accounts-list">読み込み中...</div>
        </div>

        <!-- 手動投稿 -->
        <div class="card">
          <h3>手動投稿</h3>
          <p style="font-size:13px; color:#888; margin-bottom:12px;">タイトルと本文を入力して直接投稿（AI生成なし）</p>
          <div class="form-group">
            <label>アカウント</label>
            <select id="manual-account"></select>
          </div>
          <div class="form-group">
            <label>タイトル（20文字以内）</label>
            <input type="text" id="manual-title" maxlength="20" placeholder="タイトルを入力">
          </div>
          <div class="form-group">
            <label>本文</label>
            <textarea id="manual-body" rows="8" placeholder="本文を入力"></textarea>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>投稿方法</label>
              <select id="manual-postType">
                <option value="diary">写メ日記</option>
                <option value="freepost">フリーポスト</option>
              </select>
            </div>
            <div class="form-group">
              <label>公開範囲</label>
              <select id="manual-visibility">
                <option value="public">全公開</option>
                <option value="mygirl">マイガール限定</option>
              </select>
            </div>
          </div>
          <button class="btn btn-primary" id="btn-manual-post" onclick="App.manualPost()">手動投稿する</button>
          <span id="manual-post-status" style="margin-left:12px; font-size:13px;"></span>
        </div>

        <!-- 投稿履歴 -->
        <div class="card">
          <h3>投稿履歴</h3>
          <div id="diary-history">読み込み中...</div>
        </div>

        <!-- アカウント編集モーダル -->
        <div id="modal-account" class="modal" style="display:none;">
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="modal-account-title">アカウント編集</h3>
              <button class="btn-close" onclick="App.closeModal('modal-account')">&times;</button>
            </div>
            <form id="form-account" onsubmit="App.saveAccount(event)">
              <input type="hidden" id="acc-id">

              <div class="form-grid">
                <div class="form-group">
                  <label>名前</label>
                  <input type="text" id="acc-name" required placeholder="りな">
                </div>
                <div class="form-group">
                  <label>1日の投稿数</label>
                  <input type="number" id="acc-postsPerDay" value="3" min="1" max="10">
                </div>
              </div>

              <div class="form-group">
                <label>性格</label>
                <input type="text" id="acc-personality" placeholder="明るくお茶目、アクティブなライフスタイル">
              </div>
              <div class="form-group">
                <label>口調</label>
                <input type="text" id="acc-tone" placeholder="フレンドリーで絵文字多め♪">
              </div>
              <div class="form-group">
                <label>趣味・興味（カンマ区切り）</label>
                <input type="text" id="acc-interests" placeholder="カフェ, ショッピング, 美容">
              </div>
              <div class="form-group">
                <label>文体</label>
                <input type="text" id="acc-writingStyle" placeholder="短文でテンポよく、明るい印象">
              </div>

              <hr>
              <h4>シティヘブン ログイン情報</h4>

              <div class="form-group">
                <label>ログインURL</label>
                <input type="text" id="acc-loginUrl" value="https://spgirl.cityheaven.net/">
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label>ログインID</label>
                  <input type="text" id="acc-loginId">
                </div>
                <div class="form-group">
                  <label>パスワード</label>
                  <input type="password" id="acc-loginPassword">
                </div>
              </div>
              <div class="form-group">
                <label>日記投稿URL</label>
                <input type="text" id="acc-diaryUrl" placeholder="https://spgirl.cityheaven.net/J4KeitaiDiaryPost.php?gid=...">
              </div>

              <hr>
              <h4>文体学習（過去日記から文章スタイルを真似る）</h4>

              <div class="form-group">
                <label>公開日記ページURL</label>
                <div style="display:flex; gap:8px;">
                  <input type="text" id="acc-diaryPageUrl" placeholder="https://www.cityheaven.net/.../girlid-XXXXX/diary/" style="flex:1;">
                  <button type="button" class="btn btn-sm btn-secondary" onclick="App.fetchDiarySamples()">取得</button>
                </div>
                <small>URLを入れて「取得」を押すと、公開日記からサンプルを自動取得します</small>
              </div>
              <div class="form-group">
                <label>サンプル日記（手動入力 / 自動取得結果）</label>
                <textarea id="acc-sampleDiaries" rows="6" placeholder="過去の日記をここに貼り付け（1つの日記ごとに空行で区切る）&#10;&#10;URLから自動取得した場合はここに表示されます"></textarea>
                <small id="acc-sample-count"></small>
              </div>

              <hr>
              <h4>投稿オプション</h4>

              <div class="form-grid">
                <div class="form-group">
                  <label>投稿方法</label>
                  <select id="acc-postType">
                    <option value="diary">写メ日記</option>
                    <option value="freepost">フリーポスト（24時間で消える）</option>
                    <option value="random">ランダム（毎回どちらかを自動選択）</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>公開範囲</label>
                  <select id="acc-visibility">
                    <option value="public">全公開</option>
                    <option value="mygirl">マイガール限定</option>
                    <option value="random">ランダム（毎回どちらかを自動選択）</option>
                  </select>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary">保存</button>
                <button type="button" class="btn btn-secondary" onclick="App.closeModal('modal-account')">キャンセル</button>
              </div>
            </form>
          </div>
        </div>

        <!-- 画像管理モーダル -->
        <div id="modal-images" class="modal" style="display:none;">
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="modal-images-title">画像管理</h3>
              <button class="btn-close" onclick="App.closeModal('modal-images')">&times;</button>
            </div>
            <div class="image-upload-area">
              <input type="file" id="image-upload" multiple accept="image/*" onchange="App.uploadImages(event)">
              <label for="image-upload" class="upload-label">画像をドラッグ＆ドロップ または クリックして選択</label>
            </div>
            <div id="image-list" class="image-grid"></div>
          </div>
        </div>
      </div>

      <!-- ===== 設定ページ ===== -->
      <div id="page-settings" class="page">
        <h2>設定</h2>

        <form id="form-settings" onsubmit="App.saveSettings(event)">
          <div class="card">
            <h3>AI設定（日記生成）</h3>
            <div class="form-group">
              <label>AIプロバイダー</label>
              <select id="set-aiProvider" onchange="App.toggleAIProvider()">
                <option value="gemini">Gemini（無料）</option>
                <option value="openai">OpenAI / ChatGPT（有料）</option>
              </select>
            </div>

            <div id="gemini-settings">
              <div class="form-group">
                <label>Gemini APIキー</label>
                <input type="password" id="set-geminiApiKey" placeholder="Gemini APIキーを入力">
                <small>APIキーは <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a> で無料で取得できます</small>
              </div>
              <div class="form-group">
                <label>Geminiモデル</label>
                <select id="set-geminiModel">
                  <option value="gemini-2.0-flash">gemini-2.0-flash（デフォルト）</option>
                  <option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite（軽量）</option>
                  <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite（新型・軽量）</option>
                  <option value="gemini-2.5-flash">gemini-2.5-flash（新型・高性能）</option>
                </select>
              </div>
            </div>

            <div id="openai-settings" style="display:none">
              <div class="form-group">
                <label>OpenAI APIキー</label>
                <input type="password" id="set-openaiApiKey" placeholder="sk-...">
                <small>APIキーは <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a> で取得できます（※ChatGPT課金とは別です）</small>
              </div>
              <div class="form-group">
                <label>OpenAIモデル</label>
                <select id="set-openaiModel">
                  <option value="gpt-4o-mini">gpt-4o-mini（安い・おすすめ）</option>
                  <option value="gpt-4o">gpt-4o（高性能・高い）</option>
                </select>
              </div>
            </div>
            <small>※上限エラーが出たら自動的に別のモデルにフォールバックします</small>
          </div>

          <div class="card">
            <h3>写メ日記 設定</h3>
            <div class="form-group">
              <label class="toggle-label">
                <input type="checkbox" id="set-postingEnabled">
                <span>実際にシティヘブンに投稿する</span>
              </label>
              <small>OFFの場合、日記生成のみ行い投稿はスキップします（テストモード）</small>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label>最小文字数</label>
                <input type="number" id="set-minChars" value="450">
              </div>
              <div class="form-group">
                <label>最大文字数</label>
                <input type="number" id="set-maxChars" value="1000">
              </div>
            </div>
            <div class="form-group">
              <label>スケジュール Cron式</label>
              <input type="text" id="set-schedule" value="0 */3 8-23 * * *">
              <small>デフォルト: 8時〜23時の間、3時間ごと</small>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label>デフォルト投稿方法</label>
                <select id="set-postType">
                  <option value="diary">写メ日記</option>
                  <option value="freepost">フリーポスト</option>
                  <option value="random">ランダム</option>
                </select>
              </div>
              <div class="form-group">
                <label>デフォルト公開範囲</label>
                <select id="set-visibility">
                  <option value="public">全公開</option>
                  <option value="mygirl">マイガール限定</option>
                  <option value="random">ランダム</option>
                </select>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary">設定を保存</button>
        </form>
      </div>
    </main>
  </div>

  <script src="/js/app.js"></script>
</body>
</html>
